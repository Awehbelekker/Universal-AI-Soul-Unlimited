"""
Universal Soul AI - Integration Verification Script
===================================================

Verifies 100% integration of all optimization modules.
Tests each component and provides comprehensive status report.
"""

import asyncio
import sys
from pathlib import Path

# Add project root to path
sys.path.insert(0, str(Path(__file__).parent))

from main import UniversalSoulAI


async def verify_integration():
    """Verify complete system integration"""
    print("=" * 70)
    print("UNIVERSAL SOUL AI - INTEGRATION VERIFICATION")
    print("=" * 70)
    print()
    
    try:
        # Initialize system
        print("üîß Initializing Universal Soul AI system...")
        system = UniversalSoulAI()
        await system.initialize()
        print("‚úÖ System initialized successfully")
        print()
        
        # Get system status
        status = await system.get_system_status()
        
        # Display component status
        print("üìä Component Status:")
        print("-" * 70)
        
        # Core engines
        print(f"  HRM Engine (Ollama + Qwen2.5-3B): ", end="")
        print("‚úÖ Active" if status['hrm_engine'] else "‚ùå Inactive")
        
        print(f"  CoAct-1 Engine (TerminalBench):   ", end="")
        print("‚úÖ Active" if status['coact_engine'] else "‚ùå Inactive")
        
        # Optimization engines
        print(f"  Coqui TTS (6 Personalities):      ", end="")
        tts_status = status['optimization_engines']['tts_enabled']
        print("‚úÖ Active" if tts_status else "‚ùå Inactive")
        
        print(f"  MemGPT (Long-Term Memory):        ", end="")
        mem_status = status['optimization_engines']['memory_enabled']
        print("‚úÖ Active" if mem_status else "‚ùå Inactive")
        
        print()
        print("-" * 70)
        
        # System metrics
        print("üìà System Metrics:")
        print("-" * 70)
        metrics = status['system_metrics']
        print(f"  Total Requests:       {metrics['total_requests']}")
        print(f"  Successful Requests:  {metrics['successful_requests']}")
        print(f"  Active Sessions:      {status['active_sessions']}")
        print(f"  Config Version:       {status['config_version']}")
        print()
        print("-" * 70)
        
        # Engine details
        if status['hrm_engine']:
            print("üß† HRM Engine Details:")
            print("-" * 70)
            hrm = status['hrm_engine']
            print(f"  Model:                {hrm.get('model_name', 'N/A')}")
            print(f"  Backend:              {hrm.get('backend', 'N/A')}")
            print(f"  Context Window:       {hrm.get('context_window', 'N/A')}")
            print(f"  Total Inferences:     {hrm.get('total_inferences', 0)}")
            print(f"  Avg Response Time:    "
                  f"{hrm.get('average_response_time', 0):.2f}s")
            print()
            print("-" * 70)
        
        if status['coact_engine']:
            print("ü§ñ CoAct-1 Engine Details:")
            print("-" * 70)
            coact = status['coact_engine']
            print(f"  Total Tasks:          {coact.get('total_tasks', 0)}")
            print(f"  Successful Tasks:     {coact.get('successful_tasks', 0)}")
            success_rate = coact.get('success_rate', 0)
            print(f"  Success Rate:         {success_rate:.1f}%")
            print(f"  TerminalBench Tasks:  "
                  f"{coact.get('terminalbench_tasks', 0)}")
            print()
            print("-" * 70)
        
        # Integration summary
        print()
        print("üéØ Integration Summary:")
        print("=" * 70)
        
        total_components = 4
        active_components = sum([
            bool(status['hrm_engine']),
            bool(status['coact_engine']),
            tts_status,
            mem_status
        ])
        
        integration_percentage = (active_components / total_components) * 100
        
        print(f"  Active Components:    {active_components}/{total_components}")
        print(f"  Integration Level:    {integration_percentage:.0f}%")
        print()
        
        if integration_percentage == 100:
            print("  Status:               üéâ 100% INTEGRATION COMPLETE üéâ")
            print()
            print("  All optimization modules are fully integrated and active!")
            print("  System is production-ready with:")
            print("    ‚úÖ Real AI inference (Qwen2.5-3B)")
            print("    ‚úÖ Advanced automation (TerminalBench)")
            print("    ‚úÖ Personality voices (Coqui TTS)")
            print("    ‚úÖ Long-term memory (MemGPT)")
        elif integration_percentage >= 50:
            print(f"  Status:               ‚ö†Ô∏è  {integration_percentage:.0f}% "
                  "Integration")
            print()
            print("  Core components active. Consider enabling:")
            if not tts_status:
                print("    ‚ùå Coqui TTS - Set 'coqui_tts.enabled': true")
            if not mem_status:
                print("    ‚ùå MemGPT - Set 'memgpt.enabled': true")
        else:
            print(f"  Status:               ‚ùå {integration_percentage:.0f}% "
                  "Integration")
            print()
            print("  Critical components missing. Check initialization logs.")
        
        print()
        print("=" * 70)
        
        # Test basic request processing
        print()
        print("üß™ Testing Request Processing...")
        print("-" * 70)
        
        try:
            response = await system.process_user_request(
                "Hello, what is your purpose?",
                user_id="test_user"
            )
            print("‚úÖ Request processing successful")
            print(f"   Response preview: {response[:100]}...")
            print()
        except Exception as e:
            print(f"‚ùå Request processing failed: {e}")
            print()
        
        print("-" * 70)
        
        # Shutdown
        print()
        print("üõë Shutting down system...")
        await system.shutdown()
        print("‚úÖ System shutdown complete")
        print()
        
        print("=" * 70)
        print("VERIFICATION COMPLETE")
        print("=" * 70)
        
        return integration_percentage == 100
        
    except Exception as e:
        print(f"‚ùå Verification failed: {e}")
        import traceback
        traceback.print_exc()
        return False


async def quick_health_check():
    """Quick health check without full initialization"""
    print()
    print("‚ö° Quick Health Check")
    print("-" * 70)
    
    # Check imports
    print("Checking module imports...")
    
    try:
        from core.engines.ollama_integration import OllamaIntegration
        print("  ‚úÖ Ollama integration")
    except ImportError as e:
        print(f"  ‚ùå Ollama integration: {e}")
    
    try:
        from core.engines.llama_cpp_optimizer import LlamaCppOptimizer
        print("  ‚úÖ Llama.cpp optimizer")
    except ImportError as e:
        print(f"  ‚ùå Llama.cpp optimizer: {e}")
    
    try:
        from core.engines.terminalbench_integration import (
            TerminalBenchIntegration
        )
        print("  ‚úÖ TerminalBench integration")
    except ImportError as e:
        print(f"  ‚ùå TerminalBench integration: {e}")
    
    try:
        from core.engines.coqui_tts_optimizer import CoquiTTSOptimizer
        print("  ‚úÖ Coqui TTS optimizer")
    except ImportError as e:
        print(f"  ‚ùå Coqui TTS optimizer: {e}")
    
    try:
        from core.engines.memgpt_autogen_integration import MemGPTIntegration
        print("  ‚úÖ MemGPT integration")
    except ImportError as e:
        print(f"  ‚ùå MemGPT integration: {e}")
    
    print()
    print("-" * 70)


def main():
    """Main verification entry point"""
    print()
    print("üöÄ Starting Universal Soul AI Integration Verification")
    print()
    
    # Quick health check first
    asyncio.run(quick_health_check())
    
    # Full verification
    success = asyncio.run(verify_integration())
    
    if success:
        print()
        print("‚úÖ All systems operational - ready for use!")
        print()
        sys.exit(0)
    else:
        print()
        print("‚ö†Ô∏è  Partial integration - review logs for details")
        print()
        sys.exit(1)


if __name__ == "__main__":
    main()
